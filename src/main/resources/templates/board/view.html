<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${board.title}">게시글 보기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="container mt-5">
<!-- Navigation-->
<nav class="navbar navbar-expand-lg navbar-light fixed-top py-3" id="mainNav">
    <div class="container px-4 px-lg-5">
        <a class="navbar-brand" th:href="${user} != null ? '/loginhome' : '/'">MM Community</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarResponsive" aria-controls="navbarResponsive"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ms-auto my-2 my-lg-0">
                <li class="nav-item"><a class="nav-link" href="/members/login">로그인</a></li>
                <li class="nav-item"><a class="nav-link" href="/members/join">회원가입</a></li>
            </ul>
        </div>
    </div>
</nav>

<h2 th:text="${board.title}">제목</h2>
<p class="text-muted">
    작성일: <span th:text="${#temporals.format(board.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
</p>

<p th:if="${board.createdAt != board.updatedAt}" class="text-muted">
    수정일: <span th:text="${#temporals.format(board.updatedAt, 'yyyy-MM-dd HH:mm')}"></span>
</p>

<p class="lead" th:text="${board.content}">내용</p>
<img th:if="${board.image}" th:src="${board.image}" alt="첨부 이미지" class="img-fluid" style="max-width: 400px;"/>

<div class="mt-4">
    <a class="btn btn-warning btn-sm" th:href="@{'/board/edit/' + ${board.boardId}}">수정</a>
    <form th:action="@{'/board/delete/' + ${board.boardId}}" method="post" class="d-inline">
        <button type="submit" class="btn btn-danger btn-sm">삭제</button>
    </form>
    <a class="btn btn-secondary btn-sm" th:href="@{/board}">목록</a>
</div>

<hr/>

<!-- 댓글 영역 -->
<h4 class="mt-5">댓글</h4>
<div id="reply-list" th:fragment="replyList"></div>

<!-- 댓글 작성 -->
<form id="reply-form" class="mt-3">
    <input type="hidden" id="boardId" th:value="${board.boardId}" />
    <div class="mb-2">
        <textarea id="replyContent" class="form-control" placeholder="댓글을 입력하세요" required></textarea>
    </div>
    <button type="submit" class="btn btn-primary btn-sm">댓글 작성</button>
</form>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const boardId = document.getElementById("boardId").value;

        function loadReplies() {
            fetch(`/reply/list/${boardId}`)
                .then(res => res.text())
                .then(html => {
                    document.getElementById("reply-list").innerHTML = html;

                    // 댓글 수정 처리
                    document.querySelectorAll(".edit-reply-form").forEach(form => {
                        form.addEventListener("submit", function (e) {
                            e.preventDefault();
                            const replyId = this.dataset.replyId;
                            const newContent = this.querySelector("textarea").value;
                            fetch(`/reply/update/${replyId}`, {
                                method: "POST",
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: `replyContent=${encodeURIComponent(newContent)}&boardId=${boardId}`
                            }).then(() => loadReplies());
                        });
                    });

                    // 댓글 삭제 처리
                    document.querySelectorAll(".delete-reply-form").forEach(form => {
                        form.addEventListener("submit", function (e) {
                            e.preventDefault();
                            const replyId = this.dataset.replyId;
                            fetch(`/reply/delete/${replyId}?boardId=${boardId}`, {
                                method: "POST"
                            }).then(() => loadReplies());
                        });
                    });
                });
        }

        loadReplies();

        // 댓글 작성 처리
        document.getElementById("reply-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const content = document.getElementById("replyContent").value;
            fetch("/reply/create", {
                method: "POST",
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `boardId=${boardId}&replyContent=${encodeURIComponent(content)}`
            }).then(() => {
                document.getElementById("replyContent").value = '';
                loadReplies();
            });
        });
    });
</script>


<!--<script>-->
<!--    document.addEventListener("DOMContentLoaded", function () {-->
<!--        const boardId = document.getElementById("boardId").value;-->

<!--        function loadReplies() {-->
<!--            fetch(/reply/list/${boardId})-->
<!--                .then(res => res.text())-->
<!--                .then(html => {-->
<!--                    document.getElementById("reply-list").innerHTML = html;-->

<!--                    document.querySelectorAll(".edit-reply-form").forEach(form => {-->
<!--                        form.addEventListener("submit", function (e) {-->
<!--                            e.preventDefault();-->
<!--                            const replyId = this.dataset.replyId;-->
<!--                            const newContent = this.querySelector("textarea").value;-->
<!--                            fetch(/reply/update/${replyId}, {-->
<!--                                method: "POST",-->
<!--                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },-->
<!--                                body: replyContent=${encodeURIComponent(newContent)}&boardId=${boardId}-->
<!--                            }).then(() => loadReplies());-->
<!--                        });-->
<!--                    });-->

<!--                    document.querySelectorAll(".delete-reply-form").forEach(form => {-->
<!--                        form.addEventListener("submit", function (e) {-->
<!--                            e.preventDefault();-->
<!--                            const replyId = this.dataset.replyId;-->
<!--                            fetch(/reply/delete/${replyId}?boardId=${boardId}, {-->
<!--                                method: "POST"-->
<!--                            }).then(() => loadReplies());-->
<!--                        });-->
<!--                    });-->
<!--                });-->
<!--        }-->

<!--        loadReplies();-->

<!--        document.getElementById("reply-form").addEventListener("submit", function (e) {-->
<!--            e.preventDefault();-->
<!--            const content = document.getElementById("replyContent").value;-->
<!--            fetch("/reply/create", {-->
<!--                method: "POST",-->
<!--                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },-->
<!--                body: boardId=${boardId}&replyContent=${encodeURIComponent(content)}-->
<!--            }).then(() => {-->
<!--                document.getElementById("replyContent").value = '';-->
<!--                loadReplies();-->
<!--            });-->
<!--        });-->
<!--    });-->
<!--</script>-->

</body>
</html>